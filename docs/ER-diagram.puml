@startuml School Advisories - Entity Relationship Diagram (ACTUALIZADO)

!define ENTITY class
!define ENUM enum

' ===== ENUMS =====
ENUM UserRole {
  ADMIN
  PROFESSOR  
  STUDENT
}

ENUM VenueType {
  CLASSROOM
  OFFICE
  VIRTUAL
}

ENUM WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

ENUM RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

ENUM AdvisoryStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

ENUM InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

ENUM NotificationType {
  EMAIL
  SMS
  PUSH
}

ENUM NotificationEvent {
  ADVISORY_REQUEST_NEW
  ADVISORY_REQUEST_APPROVED
  ADVISORY_REQUEST_REJECTED
  ADVISORY_CANCELLED
  REMINDER_DAILY
}

' ===== MAIN ENTITIES =====
ENTITY User {
  + user_id : number <<PK>>
  --
  name : string
  last_name : string  
  email : string <<unique>>
  phone_number : string <<unique>>
  school_id : number <<nullable>>
  username : string <<unique>>
  password : string
  photo_url : string <<nullable>>
  student_id : string <<nullable>>
  employee_id : string <<nullable>>
  role : UserRole <<default: STUDENT>>
  last_login_at : timestamp <<nullable>>
  is_active : boolean <<default: true>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY Subject {
  + subject_id : number <<PK>>
  --
  subject : string <<unique>>
}

ENTITY SubjectDetails {
  + subject_detail_id : number <<PK>>
  --
  subject_id : number <<FK>>
  professor_id : number <<FK>>
}

ENTITY SubjectSchedule {
  + subject_schedule_id : number <<PK>>
  --
  day : WeekDay
  start_time : string
  end_time : string
  subject_details_id : number <<FK>>
}

ENTITY Advisory {
  + advisory_id : number <<PK>>
  --
  professor_id : number <<FK>>
  subject_detail_id : number <<FK>>
  max_students : number
  status : AdvisoryStatus <<default: PENDING>>
  created_by_id : number <<FK, nullable>>
  cancelled_by_id : number <<FK, nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY AdvisorySchedule {
  + advisory_schedule_id : number <<PK>>
  --
  day : WeekDay
  begin_time : time
  end_time : time
  advisory_id : number <<FK>>
  max_students_per_slot : number <<default: 5>>
  is_active : boolean <<default: true>>
}

ENTITY AdvisoryDate {
  + advisory_date_id : number <<PK>>
  --
  advisory_id : number <<FK>>
  venue_id : number <<FK>>
  topic : string
  date : string
  notes : string <<nullable>>
  session_link : string <<nullable>>
  completed_at : timestamp <<nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY AdvisoryAttendance {
  + advisory_attendance_id : number <<PK>>
  --
  student_id : number <<FK>>
  advisory_date_id : number <<FK>>
  attended : boolean <<default: false>>
  notes : string <<nullable>>
  attendance_time : timestamp <<nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY Venue {
  + venue_id : number <<PK>>
  --
  name : string
  type : VenueType <<default: CLASSROOM>>
  url : string <<nullable>>
  building : string <<nullable>>
  floor : string <<nullable>>
}

ENTITY RefreshToken {
  + id : number <<PK>>
  --
  token : string
  user_id : number <<FK>>
  expires_at : timestamp
}

' ===== NUEVAS ENTIDADES IMPLEMENTADAS =====

ENTITY AdvisoryRequest {
  + request_id : number <<PK>>
  --
  student_id : number <<FK>>
  professor_id : number <<FK>>
  subject_detail_id : number <<FK>>
  status : RequestStatus <<default: PENDING>>
  student_message : text <<nullable>>
  professor_response : text <<nullable>>
  processed_at : timestamp <<nullable>>
  processed_by_id : number <<FK, nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY ProfessorAvailability {
  + availability_id : number <<PK>>
  --
  professor_id : number <<FK>>
  subject_detail_id : number <<FK, nullable>>
  day_of_week : WeekDay
  start_time : time
  end_time : time
  max_students_per_slot : number <<default: 5>>
  slot_duration_minutes : number <<default: 30>>
  is_active : boolean <<default: true>>
  is_recurring : boolean <<default: false>>
  effective_from : date <<nullable>>
  effective_until : date <<nullable>>
  notes : text <<nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY StudentInvitation {
  + invitation_id : number <<PK>>
  --
  advisory_date_id : number <<FK>>
  student_id : number <<FK>>
  invited_by_id : number <<FK>>
  status : InvitationStatus <<default: PENDING>>
  invitation_message : text <<nullable>>
  response_message : text <<nullable>>
  responded_at : timestamp <<nullable>>
  expires_at : timestamp <<nullable>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY NotificationPreferences {
  + preference_id : number <<PK>>
  --
  user_id : number <<FK>>
  email_new_request : boolean <<default: true>>
  email_request_approved : boolean <<default: true>>
  email_request_rejected : boolean <<default: true>>
  email_advisory_cancelled : boolean <<default: true>>
  email_daily_reminders : boolean <<default: true>>
  email_session_reminders : boolean <<default: true>>
  created_at : timestamp
  updated_at : timestamp
}

ENTITY NotificationLogs {
  + log_id : number <<PK>>
  --
  user_id : number <<FK>>
  notification_type : string
  subject : string
  content : text
  sent_to : string
  sent_successfully : boolean <<default: false>>
  error_message : text <<nullable>>
  sent_at : timestamp <<nullable>>
  created_at : timestamp
}

ENTITY EmailTemplate {
  + template_key : string <<PK>>
  --
  name : string
  description : string <<nullable>>
  subject : string
  html_body : text
  text_body : text <<nullable>>
  available_variables : json <<nullable>>
  is_active : boolean <<default: true>>
  created_at : timestamp
  updated_at : timestamp
}

' ===== RELATIONSHIPS =====

' User relationships
User ||--o{ SubjectDetails : "professor teaches"
User ||--o{ Advisory : "professor creates"
User ||--o{ AdvisoryAttendance : "student attends"
User ||--o{ RefreshToken : "has tokens"
User ||--o{ AdvisoryRequest : "student requests (student_id)"
User ||--o{ AdvisoryRequest : "professor receives (professor_id)"
User ||--o{ AdvisoryRequest : "admin processes (processed_by_id)"
User ||--o{ ProfessorAvailability : "professor sets availability"
User ||--o{ StudentInvitation : "student receives invitation"
User ||--o{ StudentInvitation : "professor sends invitation (invited_by_id)"
User ||--o{ NotificationPreferences : "has preferences"
User ||--o{ NotificationLogs : "receives notifications"

' Subject relationships  
Subject ||--o{ SubjectDetails : "has details"

' SubjectDetails relationships
SubjectDetails ||--o{ SubjectSchedule : "has schedules"
SubjectDetails ||--o{ Advisory : "has advisories"
SubjectDetails ||--o{ AdvisoryRequest : "requested for subject"
SubjectDetails ||--o{ ProfessorAvailability : "availability for subject"

' Advisory relationships
Advisory ||--o{ AdvisorySchedule : "has recurring schedule"
Advisory ||--o{ AdvisoryDate : "has specific dates"

' AdvisoryDate relationships
AdvisoryDate ||--o{ AdvisoryAttendance : "tracks attendance"
AdvisoryDate ||--o{ StudentInvitation : "has invitations"

' Venue relationships
Venue ||--o{ AdvisoryDate : "hosts sessions"

' ===== RELATIONSHIP DETAILS =====
note right of User
  ROLES Y FUNCIONALIDADES:
  ‚Ä¢ Professor: Teaches subjects, creates advisories, sets availability
  ‚Ä¢ Student: Requests advisories, attends sessions, gets invitations
  ‚Ä¢ Admin: Manages system, processes requests, assigns subjects
  ‚Ä¢ All roles: Have notification preferences and logs
end note

note right of AdvisoryRequest
  FLUJO DE SOLICITUDES:
  ‚Ä¢ Student creates request for specific subject/professor
  ‚Ä¢ Professor receives notification and can approve/reject
  ‚Ä¢ System automatically creates Advisory when approved
  ‚Ä¢ Full audit trail with status changes
end note

note right of ProfessorAvailability
  SISTEMA DE DISPONIBILIDAD:
  ‚Ä¢ Professors set recurring weekly availability
  ‚Ä¢ Can specify subject-specific or general availability
  ‚Ä¢ Configurable slots with duration and capacity
  ‚Ä¢ Students see availability when requesting
end note

note right of StudentInvitation
  INVITACIONES DIRECTAS:
  ‚Ä¢ Professors can invite specific students to sessions
  ‚Ä¢ Students receive invitation and can accept/decline
  ‚Ä¢ Invitations have expiry dates
  ‚Ä¢ Status tracking for all invitations
end note

note bottom of NotificationLogs
  SISTEMA DE NOTIFICACIONES:
  ‚Ä¢ All notifications logged for audit
  ‚Ä¢ Email templates configurable by admin
  ‚Ä¢ User preferences control what notifications to receive
  ‚Ä¢ Support for failed delivery tracking
end note

' ===== BUSINESS RULES ACTUALIZADAS =====
note top of SubjectDetails
  REGLAS DE MATERIAS Y ASIGNACIONES:
  ‚Ä¢ Admin gestiona asignaciones profesor-materia
  ‚Ä¢ Validaciones de unicidad y permisos
  ‚Ä¢ No eliminar materias con asignaciones activas
  ‚Ä¢ Estad√≠sticas administrativas disponibles
end note

note top of AdvisoryRequest
  REGLAS DE SOLICITUDES:
  ‚Ä¢ Estudiante solo puede solicitar materias existentes
  ‚Ä¢ No solicitudes duplicadas PENDING para misma materia
  ‚Ä¢ Solo profesor asignado puede aprobar/rechazar
  ‚Ä¢ Notificaciones autom√°ticas en cada cambio de estado
end note

note top of ProfessorAvailability
  REGLAS DE DISPONIBILIDAD:
  ‚Ä¢ Profesores definen horarios recurrentes semanales
  ‚Ä¢ Disponibilidad puede ser general o por materia espec√≠fica
  ‚Ä¢ Slots configurables con duraci√≥n y capacidad m√°xima
  ‚Ä¢ Sistema valida solapamientos de horarios
end note

note top of Advisory
  REGLAS DE ASESOR√çAS:
  ‚Ä¢ Estados: PENDING ‚Üí ACTIVE ‚Üí COMPLETED/CANCELLED
  ‚Ä¢ Capacidad m√°xima configurable por sesi√≥n
  ‚Ä¢ Registro de asistencia masiva implementado
  ‚Ä¢ Notas de sesi√≥n y links virtuales soportados
end note

note top of EmailTemplate
  SISTEMA DE PLANTILLAS:
  ‚Ä¢ Plantillas configurables por administrador
  ‚Ä¢ Variables din√°micas para personalizaci√≥n
  ‚Ä¢ Soporte HTML y texto plano
  ‚Ä¢ Templates por tipo de evento del sistema
end note

' ===== ESTADO DE IMPLEMENTACI√ìN =====
note top
  **DIAGRAMA ACTUALIZADO - NOVIEMBRE 2025**
  
  ‚úÖ **ENTIDADES IMPLEMENTADAS COMPLETAMENTE:**
  ‚Ä¢ User, Subject, SubjectDetails, Advisory, AdvisoryDate, AdvisoryAttendance
  ‚Ä¢ AdvisoryRequest (Sistema de solicitudes)
  ‚Ä¢ ProfessorAvailability (Disponibilidad recurrente)
  ‚Ä¢ StudentInvitation (Invitaciones directas)
  ‚Ä¢ NotificationPreferences, NotificationLogs, EmailTemplate (Sistema de notificaciones)
  
  üìä **FUNCIONALIDADES CORE IMPLEMENTADAS:**
  ‚Ä¢ Flujo completo de solicitudes con notificaciones autom√°ticas
  ‚Ä¢ Gesti√≥n de disponibilidad recurrente de profesores
  ‚Ä¢ Registro de asistencia masiva y gesti√≥n de sesiones
  ‚Ä¢ Sistema completo de notificaciones por email
  ‚Ä¢ Gesti√≥n administrativa de materias con validaciones
  ‚Ä¢ Invitaciones directas de profesores a estudiantes
  
  ‚ö†Ô∏è **PENDIENTE:**
  ‚Ä¢ Sistema de reportes y estad√≠sticas (Fase 7)
  ‚Ä¢ Testing comprehensivo (Fase 8)
  ‚Ä¢ Optimizaciones de producci√≥n (Fase 9)
end note

@enduml